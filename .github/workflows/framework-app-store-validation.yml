name: Framework App Store Validation

on:
  pull_request:
    branches: [main]
    paths:
      - 'Sources/FluidAudio/Frameworks/**'
      - '.github/workflows/framework-app-store-validation.yml'
  push:
    branches: [main]
    paths:
      - 'Sources/FluidAudio/Frameworks/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate-app-store-compliance:
    name: Validate App Store Compliance
    runs-on: macos-15

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Build Package
        run: |
          echo "üì¶ Building package to validate framework linkage..."
          swift build -v 2>&1 | tee build.log

      - name: Check Build Log for Framework Errors
        run: |
          echo "üîç Checking build log for framework-related errors..."

          # Check for dyld errors (broken framework structure)
          if grep -i "dyld.*error\|library not loaded\|cannot find.*framework" build.log; then
              echo "‚ùå ERROR: dyld errors detected - framework structure may be broken"
              exit 1
          fi

          # Check for code signing errors
          if grep -i "code sign\|codesign.*error" build.log | grep -v "No identity found\|Developer ID"; then
              echo "‚ö†Ô∏è  Code signing warnings (may be expected)"
          fi

          echo "‚úÖ No dyld errors detected"

      - name: Run Framework Link Tests
        run: |
          echo "üß™ Running framework linkage tests..."
          swift test -v --filter FrameworkLinkTests 2>&1 | tee test.log || true

      - name: Verify Framework Symlink Structure for App Store
        run: |
          set -e

          echo "üîó Verifying App Store compliance of framework structure..."
          echo ""

          FRAMEWORK_PATH="Sources/FluidAudio/Frameworks/ESpeakNG.xcframework"

          # Function to check App Store compliance
          check_app_store_compliance() {
              local framework_dir="$1"
              local variant_name="$2"

              if [ ! -d "$framework_dir" ]; then
                  return 0
              fi

              echo "üìã Checking $variant_name for App Store compliance..."

              # For macOS frameworks with versioning, check symlink structure
              if [ -d "$framework_dir/Versions" ]; then
                  # Apple's App Store validation requires symlinks to point to Versions/Current
                  # not directly to Versions/A (which causes ITMS-90291 errors)

                  local errors=0

                  # Check each top-level symlink
                  for symlink in ESpeakNG Headers Modules Resources; do
                      if [ -L "$framework_dir/$symlink" ]; then
                          local target=$(readlink "$framework_dir/$symlink")

                          # App Store requires Versions/Current, not Versions/A
                          if [[ "$target" == "Versions/A"* ]]; then
                              echo "  ‚ùå ITMS-90291: $symlink points to Versions/A/"
                              echo "     This would cause App Store validation failure"
                              errors=$((errors + 1))
                          elif [[ "$target" == "Versions/Current"* ]]; then
                              echo "  ‚úì $symlink ‚Üí Versions/Current/ (App Store compliant)"
                          else
                              echo "  ‚ùå Unexpected symlink target: $symlink ‚Üí $target"
                              errors=$((errors + 1))
                          fi
                      fi
                  done

                  local info_current="$framework_dir/Versions/Current/Resources/Info.plist"
                  local info_symlink="$framework_dir/Resources/Info.plist"
                  if [ ! -f "$info_current" ]; then
                      echo "  ‚ùå Info.plist missing at Versions/Current/Resources/Info.plist"
                      errors=$((errors + 1))
                  else
                      echo "  ‚úì Info.plist located at Versions/Current/Resources/Info.plist"
                  fi
                  if [ ! -f "$info_symlink" ]; then
                      echo "  ‚ùå Resources/Info.plist symlink missing"
                      errors=$((errors + 1))
                  fi

                  if [ $errors -gt 0 ]; then
                      return 1
                  fi
              fi

              return 0
          }

          # Check all variants
          all_valid=true
          for variant in "$FRAMEWORK_PATH"/*; do
              if [ -d "$variant" ] && [ -d "$variant/ESpeakNG.framework" ]; then
                  variant_name=$(basename "$variant")
                  if ! check_app_store_compliance "$variant/ESpeakNG.framework" "$variant_name"; then
                      all_valid=false
                  fi
              fi
          done

          if [ "$all_valid" = true ]; then
              echo ""
              echo "‚úÖ Framework structure is App Store compliant"
              exit 0
          else
              echo ""
              echo "‚ùå Framework structure has App Store compliance issues"
              exit 1
          fi

      - name: Validate Framework Resources
        run: |
          echo "üì¶ Validating framework resources..."
          echo ""

          FRAMEWORK_PATH="Sources/FluidAudio/Frameworks/ESpeakNG.xcframework"

          found_resources=false
          while IFS= read -r -d '' framework_dir; do
              found_resources=true
              if [ -L "$framework_dir/Resources" ]; then
                  echo "‚úì $(basename "$framework_dir") Resources symlink resolves"
                  resource_count=$(find "$framework_dir/Resources" -type f | wc -l | tr -d '[:space:]')
                  echo "  Found $resource_count resource files"
              elif [ -d "$framework_dir/Resources" ]; then
                  echo "‚ö†Ô∏è  $(basename "$framework_dir") has a real Resources directory (expected symlink for versioned frameworks)"
              fi
          done < <(find "$FRAMEWORK_PATH" -type d -name "ESpeakNG.framework" -print0)

          if [ "$found_resources" = false ]; then
              echo "‚ö†Ô∏è  No ESpeakNG.framework directories found when validating resources"
          fi

          echo "‚úÖ Resources validation complete"

      - name: Summary
        if: always()
        run: |
          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "Framework Validation Summary"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          echo "‚úì Build log checked for dyld errors"
          echo "‚úì Framework linkage verified"
          echo "‚úì Symlink structure validated"
          echo "‚úì App Store compliance verified"
          echo ""
          echo "These checks catch:"
          echo "  ‚Ä¢ Binary naming errors (e.g., ESPeakNG vs ESpeakNG)"
          echo "  ‚Ä¢ Broken symlink chains"
          echo "  ‚Ä¢ ITMS-90291 validation errors"
          echo "  ‚Ä¢ Framework structure compliance issues"
          echo ""
