name: Framework Structure Validation

on:
  pull_request:
    branches: [main]
    paths:
      - 'Sources/FluidAudio/Frameworks/**'
  push:
    branches: [main]
    paths:
      - 'Sources/FluidAudio/Frameworks/**'

jobs:
  validate-framework-structure:
    name: Validate Framework Structure
    runs-on: macos-15

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Check ESpeakNG Framework Structure
        run: |
          set -e

          FRAMEWORK_PATH="Sources/FluidAudio/Frameworks/ESpeakNG.xcframework"

          echo "üîç Validating framework structure..."
          echo ""

          # Function to validate a single framework variant
          validate_framework() {
              local variant_path="$1"
              local variant_name=$(basename $(dirname "$variant_path"))

              if [ ! -d "$variant_path" ]; then
                  echo "‚ö†Ô∏è  Skipping $variant_name (not found)"
                  return 0
              fi

              echo "üì¶ Validating $variant_name variant..."

              # Check if framework uses versioning (macOS arm64) or flat structure (iOS)
              if [ -d "$variant_path/Versions" ]; then
                  echo "  ‚úì Versioned framework detected"

                  # Check Versions/Current symlink exists
                  if [ ! -L "$variant_path/Versions/Current" ]; then
                      echo "  ‚ùå ERROR: Versions/Current symlink not found"
                      return 1
                  fi
                  echo "  ‚úì Versions/Current symlink exists"

                  # Check Versions/Current points to A
                  local current_target=$(readlink "$variant_path/Versions/Current")
                  if [ "$current_target" != "A" ]; then
                      echo "  ‚ùå ERROR: Versions/Current points to '$current_target' instead of 'A'"
                      return 1
                  fi
                  echo "  ‚úì Versions/Current ‚Üí A"

                  # Check top-level symlinks point to Versions/Current/* (not Versions/A/*)
                  local symlinks=("ESpeakNG" "Headers" "Modules" "Resources")
                  for symlink in "${symlinks[@]}"; do
                      if [ ! -L "$variant_path/$symlink" ]; then
                          echo "  ‚ùå ERROR: $symlink is not a symlink"
                          return 1
                      fi

                      local target=$(readlink "$variant_path/$symlink")
                      if [[ ! "$target" =~ ^Versions/Current/ ]]; then
                          echo "  ‚ùå ERROR: $symlink points to '$target' instead of Versions/Current/*"
                          return 1
                      fi
                  done
                  echo "  ‚úì Top-level symlinks point to Versions/Current/*"

                  # Check that the actual binary exists and is valid
                  local binary_path="$variant_path/Versions/A/ESpeakNG"
                  if [ ! -f "$binary_path" ]; then
                      echo "  ‚ùå ERROR: Binary not found at $binary_path"
                      return 1
                  fi
                  echo "  ‚úì Binary file exists: Versions/A/ESpeakNG"

                  # Verify it's a valid Mach-O binary
                  local file_type=$(file "$binary_path" | grep -o "Mach-O\|executable")
                  if [ -z "$file_type" ]; then
                      echo "  ‚ùå ERROR: Binary is not a valid Mach-O file"
                      return 1
                  fi
                  echo "  ‚úì Valid Mach-O binary"

                  # Try to verify code signature (if signed)
                  if codesign -v "$binary_path" 2>/dev/null; then
                      echo "  ‚úì Code signature valid"
                  else
                      echo "  ‚ö†Ô∏è  Code signature not valid (expected for local builds)"
                  fi
              else
                  # Flat framework structure (iOS)
                  echo "  ‚úì Flat framework structure detected (iOS)"

                  # Check binary exists directly
                  local binary_path="$variant_path/ESpeakNG"
                  if [ ! -f "$binary_path" ]; then
                      echo "  ‚ùå ERROR: Binary not found at ESpeakNG"
                      return 1
                  fi
                  echo "  ‚úì Binary file exists: ESpeakNG"

                  # Verify it's a valid Mach-O binary
                  local file_type=$(file "$binary_path" | grep -o "Mach-O\|executable")
                  if [ -z "$file_type" ]; then
                      echo "  ‚ùå ERROR: Binary is not a valid Mach-O file"
                      return 1
                  fi
                  echo "  ‚úì Valid Mach-O binary"
              fi

              echo ""
              return 0
          }

          # Validate all framework variants
          all_valid=true
          for variant in "$FRAMEWORK_PATH"/*; do
              if [ -d "$variant" ] && [ -d "$variant/ESpeakNG.framework" ]; then
                  validate_framework "$variant/ESpeakNG.framework" || all_valid=false
              fi
          done

          if [ "$all_valid" = true ]; then
              echo "‚úÖ All framework variants are valid!"
              exit 0
          else
              echo "‚ùå Framework validation failed"
              exit 1
          fi

      - name: Check for Common Framework Issues
        run: |
          set -e

          FRAMEWORK_PATH="Sources/FluidAudio/Frameworks/ESpeakNG.xcframework"

          echo "üîé Checking for common framework structure issues..."
          echo ""

          # Check for case sensitivity issues in binary names
          for framework in "$FRAMEWORK_PATH"/**/ESpeakNG.framework/Versions/A; do
              if [ -d "$framework" ]; then
                  # Use ls with grep to check for exact case typo on case-insensitive filesystems
                  if ls "$framework" 2>/dev/null | grep -x "ESPeakNG" > /dev/null; then
                      echo "‚ùå ERROR: Found 'ESPeakNG' (typo) instead of 'ESpeakNG'"
                      echo "   This would cause dyld errors at runtime"
                      exit 1
                  fi
              fi
          done

          echo "‚úÖ No case sensitivity issues found"
          echo ""

          # Check for broken symlinks
          echo "üîó Checking for broken symlinks..."
          for framework in "$FRAMEWORK_PATH"/**/ESpeakNG.framework; do
              if [ -d "$framework" ]; then
                  while IFS= read -r -d '' link; do
                      if [ -L "$link" ] && ! [ -e "$link" ]; then
                          echo "‚ùå ERROR: Broken symlink: $(basename $link)"
                          exit 1
                      fi
                  done < <(find "$framework" -type l -print0)
              fi
          done

          echo "‚úÖ All symlinks are valid"
