name: Framework Structure Validation

on:
  pull_request:
    branches: [main]
    paths:
      - 'Sources/FluidAudio/Frameworks/**'
  push:
    branches: [main]
    paths:
      - 'Sources/FluidAudio/Frameworks/**'

jobs:
  validate-framework-structure:
    name: Validate Framework Structure
    runs-on: macos-15

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Check ESpeakNG Framework Structure
        run: |
          set -e

          FRAMEWORK_PATH="Sources/FluidAudio/Frameworks/ESpeakNG.xcframework"

          echo "üîç Validating framework structure..."
          echo ""

          # Function to validate a single framework variant
          validate_framework() {
              local variant_path="$1"
              local variant_name=$(basename "$(dirname "$variant_path")")
              local variant_name_lower=$(echo "$variant_name" | tr '[:upper:]' '[:lower:]')
              local requires_versioned=false

              # Mac Catalyst and macOS variants must be packaged as versioned bundles
              if [[ "$variant_name_lower" == *"maccatalyst"* || "$variant_name_lower" == *"macos"* ]]; then
                  requires_versioned=true
              fi

              if [ ! -d "$variant_path" ]; then
                  echo "‚ö†Ô∏è  Skipping $variant_name (not found)"
                  return 0
              fi

              echo "üì¶ Validating $variant_name variant..."

              # Check if framework uses versioning (macOS / Catalyst) or flat structure (iOS)
              if [ -d "$variant_path/Versions" ]; then
                  echo "  ‚úì Versioned framework detected"

                  # Check Versions/Current symlink exists
                  if [ ! -L "$variant_path/Versions/Current" ]; then
                      echo "  ‚ùå ERROR: Versions/Current symlink not found"
                      return 1
                  fi
                  echo "  ‚úì Versions/Current symlink exists"

                  # Check Versions/Current points to A
                  local current_target
                  current_target=$(readlink "$variant_path/Versions/Current")
                  if [ "$current_target" != "A" ]; then
                      echo "  ‚ùå ERROR: Versions/Current points to '$current_target' instead of 'A'"
                      return 1
                  fi
                  echo "  ‚úì Versions/Current ‚Üí A"

                  # Check top-level symlinks point to Versions/Current/* (not Versions/A/*)
                  local symlinks=("ESpeakNG" "Headers" "Modules" "Resources")
                  for symlink in "${symlinks[@]}"; do
                      if [ ! -L "$variant_path/$symlink" ]; then
                          echo "  ‚ùå ERROR: $symlink is not a symlink"
                          return 1
                      fi

                      local target
                      target=$(readlink "$variant_path/$symlink")
                      if [[ ! "$target" =~ ^Versions/Current/ ]]; then
                          echo "  ‚ùå ERROR: $symlink points to '$target' instead of Versions/Current/*"
                          return 1
                      fi
                  done
                  echo "  ‚úì Top-level symlinks point to Versions/Current/*"

                  # Ensure Info.plist is stored within the versioned resources
                  local info_plist_versioned="$variant_path/Versions/A/Resources/Info.plist"
                  local info_plist_current="$variant_path/Versions/Current/Resources/Info.plist"
                  local info_plist_resources="$variant_path/Resources/Info.plist"
                  if [ ! -f "$info_plist_versioned" ]; then
                      echo "  ‚ùå ERROR: Info.plist missing at Versions/A/Resources/Info.plist"
                      return 1
                  fi
                  if [ ! -f "$info_plist_current" ]; then
                      echo "  ‚ùå ERROR: Info.plist missing at Versions/Current/Resources/Info.plist"
                      return 1
                  fi
                  if [ ! -f "$info_plist_resources" ]; then
                      echo "  ‚ùå ERROR: Info.plist missing via Resources/Info.plist symlink"
                      return 1
                  fi
                  echo "  ‚úì Info.plist correctly nested inside Resources"

                  # Check that the actual binary exists and is valid
                  local binary_path="$variant_path/Versions/A/ESpeakNG"
                  if [ ! -f "$binary_path" ]; then
                      echo "  ‚ùå ERROR: Binary not found at $binary_path"
                      return 1
                  fi
                  echo "  ‚úì Binary file exists: Versions/A/ESpeakNG"

                  # Verify it's a valid Mach-O binary
                  local file_type
                  file_type=$(file "$binary_path" | grep -o "Mach-O\|executable")
                  if [ -z "$file_type" ]; then
                      echo "  ‚ùå ERROR: Binary is not a valid Mach-O file"
                      return 1
                  fi
                  echo "  ‚úì Valid Mach-O binary"

                  # Try to verify code signature (if signed)
                  if codesign -v "$binary_path" 2>/dev/null; then
                      echo "  ‚úì Code signature valid"
                  else
                      echo "  ‚ö†Ô∏è  Code signature not valid (expected for local builds)"
                  fi
              else
                  if [ "$requires_versioned" = true ]; then
                      echo "  ‚ùå ERROR: $variant_name must use a versioned framework layout (missing Versions/ directory)"
                      return 1
                  fi

                  # Flat framework structure (iOS)
                  echo "  ‚úì Flat framework structure detected (iOS)"

                  # Check binary exists directly
                  local binary_path="$variant_path/ESpeakNG"
                  if [ ! -f "$binary_path" ]; then
                      echo "  ‚ùå ERROR: Binary not found at ESpeakNG"
                      return 1
                  fi
                  echo "  ‚úì Binary file exists: ESpeakNG"

                  # Verify it's a valid Mach-O binary
                  local file_type
                  file_type=$(file "$binary_path" | grep -o "Mach-O\|executable")
                  if [ -z "$file_type" ]; then
                      echo "  ‚ùå ERROR: Binary is not a valid Mach-O file"
                      return 1
                  fi
                  echo "  ‚úì Valid Mach-O binary"
              fi

              echo ""
              return 0
          }
          # Validate all framework variants
          all_valid=true
          for variant in "$FRAMEWORK_PATH"/*; do
              if [ -d "$variant" ] && [ -d "$variant/ESpeakNG.framework" ]; then
                  validate_framework "$variant/ESpeakNG.framework" || all_valid=false
              fi
          done

          if [ "$all_valid" = true ]; then
              echo "‚úÖ All framework variants are valid!"
              exit 0
          else
              echo "‚ùå Framework validation failed"
              exit 1
          fi

      - name: Check for Common Framework Issues
        run: |
          set -e

          FRAMEWORK_PATH="Sources/FluidAudio/Frameworks/ESpeakNG.xcframework"

          echo "üîé Checking for common framework structure issues..."
          echo ""

          echo "üî† Verifying binary casing inside versioned frameworks..."
          found_versioned=false
          while IFS= read -r -d '' version_dir; do
              found_versioned=true
              actual_name=$(python3 -c 'import os, sys; path=sys.argv[1]; target="espeakng"; print(next((n for n in os.listdir(path) if n.lower()==target), ""))' "$version_dir")
              if [ -z "$actual_name" ]; then
                  echo "‚ùå ERROR: No ESpeakNG binary found inside $version_dir"
                  exit 1
              fi
              if [ "$actual_name" != "ESpeakNG" ]; then
                  echo "‚ùå ERROR: Binary '$actual_name' found in $version_dir (expected ESpeakNG)"
                  echo "   This would cause dyld errors on case-sensitive filesystems"
                  exit 1
              fi
          done < <(find "$FRAMEWORK_PATH" -type d -path "*/ESpeakNG.framework/Versions/A" -print0)

          if [ "$found_versioned" = false ]; then
              echo "  ‚ö†Ô∏è  No versioned frameworks found to inspect"
          else
              echo "  ‚úì Binary casing validated in versioned slices"
          fi

          echo ""
          echo "üîó Checking for broken symlinks..."
          while IFS= read -r -d '' framework; do
              while IFS= read -r -d '' link; do
                  if [ -L "$link" ] && ! [ -e "$link" ]; then
                      echo "‚ùå ERROR: Broken symlink: $(basename "$link")"
                      exit 1
                  fi
              done < <(find "$framework" -type l -print0)
          done < <(find "$FRAMEWORK_PATH" -type d -name "ESpeakNG.framework" -print0)

          echo "‚úÖ All symlinks are valid"
